<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-08-23 Tue 18:44 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AutoTools</title>
<meta name="author" content="DESKTOP-ZHJ" />
<meta name="description" content="Keep It Simple, Stupid" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="/static/site.css" />
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">AutoTools</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgaa5aa69">1. Hello World</a>
<ul>
<li><a href="#org90cc02d">1.1. 创建文件</a></li>
<li><a href="#org80b327c">1.2. autoreconf &#x2013;install</a></li>
<li><a href="#orgb8b762e">1.3. <code>./configure</code></a></li>
<li><a href="#org6fd8ea7">1.4. <code>make</code></a></li>
<li><a href="#org7380b13">1.5. 编译、链接成功，运行程序: <code>src/hello</code></a></li>
<li><a href="#org703f203">1.6. 源码打包: <code>make distcheck</code></a></li>
<li><a href="#org8d2d837">1.7. 解包，查看文件内容</a></li>
</ul>
</li>
<li><a href="#orge65f7c7">2. Autotools 核心介绍</a>
<ul>
<li><a href="#orgd99079f">2.1. GNU AutoConf</a></li>
<li><a href="#org72cd3e0">2.2. GNU AutoMake</a></li>
<li><a href="#org9dcaf27">2.3. autoreconf</a></li>
</ul>
</li>
<li><a href="#orga1fb880">3. Hello World 讲解</a>
<ul>
<li><a href="#org067257c">3.1. configure.ac</a></li>
<li><a href="#orgf83bba3">3.2. Makefile.am</a></li>
<li><a href="#org83ad1c1">3.3. src/Makefile.am</a></li>
</ul>
</li>
<li><a href="#orgc033e41">4. 使用 Autoconf</a>
<ul>
<li><a href="#orge4c94b6">4.1. 从 configure.ac 到 configure 和 config.h.in</a></li>
<li><a href="#orgf5a8375">4.2. 探索 M4</a></li>
<li><a href="#org3402ffa">4.3. M4 基础上的 Autoconf</a></li>
<li><a href="#org0af2a4b">4.4. 一个 configure.ac 的结构</a></li>
</ul>
</li>
<li><a href="#org63dafd9">5. 使用 Automake</a>
<ul>
<li><a href="#orgd501f2d">5.1. Automake 规则</a></li>
<li><a href="#orgacce477">5.2. 在 <b>configure.ac</b> 中声明 Automake</a></li>
<li><a href="#orgede369a">5.3. 声明源文件</a></li>
<li><a href="#org7764c6a">5.4. (静态)库</a></li>
<li><a href="#org07966af">5.5. 目录结构</a></li>
<li><a href="#orgbe71170">5.6. $(srcdir) and VPATH Builds</a></li>
<li><a href="#orgf40677d">5.7. Convenience Libraries</a></li>
<li><a href="#orgf59846e">5.8. Per-Target Flags</a></li>
<li><a href="#org7516450">5.9. What Gets Distributed</a></li>
<li><a href="#orgdeb3c23">5.10. 扩展的 Automake 规则</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
本文档整理自: <a href="https://www.lrde.epita.fr/~adl/dl/autotools.pdf">Autotools Tutorial: Part II</a>
</p>

<div id="outline-container-orgaa5aa69" class="outline-2">
<h2 id="orgaa5aa69"><span class="section-number-2">1.</span> Hello World</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org90cc02d" class="outline-3">
<h3 id="org90cc02d"><span class="section-number-3">1.1.</span> 创建文件</h3>
<div class="outline-text-3" id="text-1-1">
<p>
<b>src/main.c</b>
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #a0132f;">#include</span> <span style="color: #000000;">&lt;</span><span style="color: #2544bb;">config.h</span><span style="color: #000000;">&gt;</span>
<span style="color: #a0132f;">#include</span> <span style="color: #000000;">&lt;</span><span style="color: #2544bb;">stdio.h</span><span style="color: #000000;">&gt;</span>

<span style="color: #005a5f;">int</span> <span style="color: #721045;">main</span><span style="color: #000000;">(</span><span style="color: #005a5f;">void</span><span style="color: #000000;">)</span>
<span style="color: #000000;">{</span>
    puts <span style="color: #a8007f;">(</span><span style="color: #2544bb;">"Hello World!"</span><span style="color: #a8007f;">)</span>;
    puts <span style="color: #a8007f;">(</span><span style="color: #2544bb;">"This is "</span> PACKAGE_STRING <span style="color: #2544bb;">"."</span><span style="color: #a8007f;">)</span>;
    <span style="color: #5317ac;">return</span> 0;
<span style="color: #000000;">}</span>
</pre>
</div>

<p>
<b>configure.ac</b>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #721045;">AC_INIT</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>amhello<span style="color: #a8007f;">]</span>, <span style="color: #a8007f;">[</span>1.0<span style="color: #a8007f;">]</span>, <span style="color: #a8007f;">[</span>bug-report@address<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
<span style="color: #721045;">AM_INIT_AUTOMAKE</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>foreign -Wall -Werror<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
AC_PROG_CC
<span style="color: #721045;">AC_CONFIG_HEADER</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>config.h<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
<span style="color: #721045;">AC_CONFIG_FILES</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>Makefile src/Makefile<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
AC_OUTPUT
</pre>
</div>

<p>
<b>Makefile.am</b>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">SUBDIRS</span> = src
</pre>
</div>

<p>
<b>src/Makefile.am</b>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">bin_PROGRAMS</span> = hello
<span style="color: #00538b;">hello_SOURCES</span> = main.c
</pre>
</div>

<p>
此时的文件结构为(`ls -R`):
</p>

<div class="org-src-container">
<pre class="src src-shell">.:
Makefile.am  configure.ac  src

src:
Makefile.am  main.c
</pre>
</div>
</div>
</div>

<div id="outline-container-org80b327c" class="outline-3">
<h3 id="org80b327c"><span class="section-number-3">1.2.</span> autoreconf &#x2013;install</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-shell">$: autoreconf --install
configure.ac:2: installing <span style="color: #8f0075;">`./install-sh'</span>
<span style="color: #8f0075;">configure.ac:2: installing `</span>./missing<span style="color: #2544bb;">'</span>
<span style="color: #2544bb;">src/Makefile.am: installing `./depcomp'</span>
</pre>
</div>

<p>
此时的文件结构为:
</p>

<div class="org-src-container">
<pre class="src src-shell">.:
Makefile.am  aclocal.m4      config.h.in  configure.ac  install-sh  src
Makefile.in  autom4te.cache  configure    depcomp       missing

autom4te.cache:
output.0  output.1  requests  traces.0  traces.1

src:
Makefile.am  Makefile.in  main.c
</pre>
</div>

<ul class="org-ul">
<li>Makefile.in config.h.in configure* src/Makefile.in : expected configuration templates.</li>
<li>aclocal.m4 : denitions for third-party macros used in <b>configure.ac</b>.</li>
<li>depcomp* install-sh* missing* : auxiliary tools used during the build.</li>
<li>autom4te.cache/ autom4te.cache/* : Autotools cache files</li>
</ul>
</div>
</div>

<div id="outline-container-orgb8b762e" class="outline-3">
<h3 id="orgb8b762e"><span class="section-number-3">1.3.</span> <code>./configure</code></h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-shell">checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /bin/mkdir -p
checking for gawk... gawk
checking whether make sets $<span style="color: #000000;">(</span>MAKE<span style="color: #000000;">)</span>... yes
checking for gcc... gcc
...
configure: creating ./config.status
config.status: creating Makefile
config.status: creating src/Makefile
config.status: creating config.h
config.status: executing depfiles commands
</pre>
</div>
</div>
</div>

<div id="outline-container-org6fd8ea7" class="outline-3">
<h3 id="org6fd8ea7"><span class="section-number-3">1.4.</span> <code>make</code></h3>
<div class="outline-text-3" id="text-1-4">
<pre class="example">
/usr/bin/make  all-recursive
make[1]: Entering directory `/home/zhangjie/TempFile/src'
Making all in src
make[2]: Entering directory `/home/zhangjie/TempFile/src/src'
gcc -DHAVE_CONFIG_H -I. -I..     -g -O2 -MT main.o -MD -MP -MF .deps/main.Tpo -c -o main.o main.c
mv -f .deps/main.Tpo .deps/main.Po
gcc  -g -O2   -o hello main.o
make[2]: Leaving directory `/home/zhangjie/TempFile/src/src'
make[2]: Entering directory `/home/zhangjie/TempFile/src'
make[2]: Leaving directory `/home/zhangjie/TempFile/src'
make[1]: Leaving directory `/home/zhangjie/TempFile/src'
</pre>
</div>
</div>

<div id="outline-container-org7380b13" class="outline-3">
<h3 id="org7380b13"><span class="section-number-3">1.5.</span> 编译、链接成功，运行程序: <code>src/hello</code></h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">
<pre class="src src-shell">$: src/hello
Hello World!
This is amhello 1.0.
</pre>
</div>
</div>
</div>

<div id="outline-container-org703f203" class="outline-3">
<h3 id="org703f203"><span class="section-number-3">1.6.</span> 源码打包: <code>make distcheck</code></h3>
<div class="outline-text-3" id="text-1-6">
<div class="org-src-container">
<pre class="src src-shell">$: make distcheck
...
=============================================
amhello-1.0 archives ready for distribution:
amhello-1.0.tar.gz
============================================
</pre>
</div>
</div>
</div>

<div id="outline-container-org8d2d837" class="outline-3">
<h3 id="org8d2d837"><span class="section-number-3">1.7.</span> 解包，查看文件内容</h3>
<div class="outline-text-3" id="text-1-7">
<div class="org-src-container">
<pre class="src src-shell">$ tar ztf amhello-1.0.tar.gz
amhello-1.0/
amhello-1.0/Makefile.am
amhello-1.0/aclocal.m4
amhello-1.0/configure.ac
amhello-1.0/src/
amhello-1.0/src/Makefile.am
amhello-1.0/src/main.c
amhello-1.0/src/Makefile.in
amhello-1.0/config.h.in
amhello-1.0/Makefile.in
amhello-1.0/missing
amhello-1.0/configure
amhello-1.0/depcomp
amhello-1.0/install-sh
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge65f7c7" class="outline-2">
<h2 id="orge65f7c7"><span class="section-number-2">2.</span> Autotools 核心介绍</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgd99079f" class="outline-3">
<h3 id="orgd99079f"><span class="section-number-3">2.1.</span> GNU AutoConf</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li><code>autoconf</code> : Create <b>configure</b> from <b>configure.ac</b> .</li>
<li><code>autoheader</code> : Create <b>config.h.in</b> from <b>configure.ac</b> .</li>
<li><code>autoreconf</code> : Run all tools in the right order.</li>
<li><code>autoscan</code> : Scan sources for common portability problems, and related macros missing from <b>configure.ac</b> .</li>
<li><code>autoupdate</code> : Update obsolete macros in <b>configure.ac</b> .</li>
<li><code>ifnames</code> : Gather identiers from all <code>#if/#ifdef/...</code> directives.</li>
<li><code>autom4te</code> :  The heart of Autoconf. It drives M4 and implements the</li>
</ul>
<p>
features used by most of the above tools. Useful for
creating more than just <b>configure</b> files.
</p>
</div>
</div>

<div id="outline-container-org72cd3e0" class="outline-3">
<h3 id="org72cd3e0"><span class="section-number-3">2.2.</span> GNU AutoMake</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li><code>automake</code> : Create <b>Makefile.in*s from *Makefile.am*s and *configure.ac</b> .</li>
<li><code>aclocal</code> : Scan <code>configure.ac</code> for uses of third-party macros, and</li>
</ul>
<p>
gather denitions in <code>aclocal.m4</code>.
</p>
</div>
</div>

<div id="outline-container-org9dcaf27" class="outline-3">
<h3 id="org9dcaf27"><span class="section-number-3">2.3.</span> autoreconf</h3>
<div class="outline-text-3" id="text-2-3">
<p>
![autoreconf](/attach/compile/autoreconf.jpg)
</p>

<p>
在实际应用中:
</p>

<ul class="org-ul">
<li>没必要记住所有工具之间的关系；</li>
<li>在初始化的时候，使用 <code>autoreconf --install</code> ；</li>
<li>修改输出(配置)文件的时候，重建规则；</li>
<li>你需对解每个工具产生的错误都有一个粗糙的理解（至少要知道是谁产生的错误）。</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orga1fb880" class="outline-2">
<h2 id="orga1fb880"><span class="section-number-2">3.</span> Hello World 讲解</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org067257c" class="outline-3">
<h3 id="org067257c"><span class="section-number-3">3.1.</span> configure.ac</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #721045;">AC_INIT</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>amhello<span style="color: #a8007f;">]</span>, <span style="color: #a8007f;">[</span>1.0<span style="color: #a8007f;">]</span>, <span style="color: #a8007f;">[</span>bug-report@address<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
<span style="color: #721045;">AM_INIT_AUTOMAKE</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>foreign -Wall -Werror<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
AC_PROG_CC
<span style="color: #721045;">AC_CONFIG_HEADER</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>config.h<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
<span style="color: #721045;">AC_CONFIG_FILES</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>Makefile src/Makefile<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
AC_OUTPUT
</pre>
</div>

<ul class="org-ul">
<li><code>AC_INIT</code>: Initialize <b>Autoconf</b>. Specify package's name, version number, and bug-report address.</li>
<li><code>AM_INIT_AUTOMAKE</code>: Initialize <b>Automake</b>. Turn on all Automake warnning and report them as errors. This is a foreign package.</li>
<li><code>AC_PROG_CC</code>: Check for a C compiler.</li>
<li><code>AC_CONFIG_HEADER([config.h])</code>: Declare <b>config.h</b> as output header.</li>
<li><code>AC_CONFIG_FILES</code>: Declare <b>Makefile</b> and <b>src/Makefile</b> as output files.</li>
<li><code>AC_OUTPUT</code>: Actually output all declared files.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf83bba3" class="outline-3">
<h3 id="orgf83bba3"><span class="section-number-3">3.2.</span> Makefile.am</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">SUBDIRS</span> = src
</pre>
</div>

<ul class="org-ul">
<li>Build recursively in <code>*src/*</code>.</li>
<li>Nothing else is declared for the current directory.(The top-level <b>Makefile.am</b> is usually short.)</li>
</ul>
</div>
</div>

<div id="outline-container-org83ad1c1" class="outline-3">
<h3 id="org83ad1c1"><span class="section-number-3">3.3.</span> src/Makefile.am</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">bin_PROGRAMS</span> = hello
<span style="color: #00538b;">hello_SOURCES</span> = main.c
</pre>
</div>

<ul class="org-ul">
<li>We are building some programs.</li>
<li>These programs will be installed in <b>bindir</b> (注意看下面tip的结构).</li>
<li>There is only one program to build: <b>hello</b>.</li>
<li>To create <b>hello</b>, just compile <b>main.c</b>.</li>
</ul>

<p>
<b>tip</b>: Standard File System Hierarchy:
</p>

<p>
![](/attach/compile/sys_hierarchy.jpg)
</p>
</div>
</div>
</div>

<div id="outline-container-orgc033e41" class="outline-2">
<h2 id="orgc033e41"><span class="section-number-2">4.</span> 使用 Autoconf</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orge4c94b6" class="outline-3">
<h3 id="orge4c94b6"><span class="section-number-3">4.1.</span> 从 configure.ac 到 configure 和 config.h.in</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>"autoconf is a macro processor.</li>
<li>It converts <b>configure.ac</b>, which is a shell script using macro instructions, into <b>congfiure</b>, a full-fledged shell script.</li>
<li>Autoconf offers many macros to perform common conguration checks.</li>
<li>It is not uncommon to have a <b>configure.ac</b> without shell construct, using only macros.</li>
<li>While processing <b>configure.ac</b> it is also possible to trace the occurrences of macros. This is how "autoheader" creates <b>config.h.in</b> . It just looks for the macros that #define symbols.</li>
<li>The real macro processor actually is GNU M4. Autoconf offers some infrastructure on top of that, plus the pool of macros.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf5a8375" class="outline-3">
<h3 id="orgf5a8375"><span class="section-number-3">4.2.</span> 探索 M4</h3>
<div class="outline-text-3" id="text-4-2">
<p>
<b>exmple.m4:</b>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #721045;">m4_define</span><span style="color: #000000;">(</span>NAME1, Harry<span style="color: #000000;">)</span>
<span style="color: #721045;">m4_define</span><span style="color: #000000;">(</span>NAME2, Sally<span style="color: #000000;">)</span>
<span style="color: #721045;">m4_define</span><span style="color: #000000;">(</span>MET, $<span style="color: #00538b;">1</span> met $<span style="color: #00538b;">2</span><span style="color: #000000;">)</span>
<span style="color: #721045;">MET</span><span style="color: #000000;">(</span>NAME1, NAME2<span style="color: #000000;">)</span>
</pre>
</div>

<p>
output:
</p>

<div class="org-src-container">
<pre class="src src-shell">$: m4 -P example.m4
<span style="color: #505050;"># </span><span style="color: #505050;">&#31354;&#30333;</span>
<span style="color: #505050;"># </span><span style="color: #505050;">&#31354;&#30333;</span>
<span style="color: #505050;"># </span><span style="color: #505050;">&#31354;&#30333;</span>
Harry met Sally
</pre>
</div>

<p>
M4 是一个宏处理器，将输出拷贝到输出。可以内嵌，也可以用户自定义，除了宏展开以外，M4还有一些内建的函数，用来引用文件、执行Unix命令、文本操作、循环等。
</p>

<p>
这里不详细展开表述 M4，但是要记住 M4 是 Autoconf 的核心，Autoconf 只是封装了一些指令而已。
</p>
</div>
</div>

<div id="outline-container-org3402ffa" class="outline-3">
<h3 id="org3402ffa"><span class="section-number-3">4.3.</span> M4 基础上的 Autoconf</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>在许多机器上， Auto = M4，和一些预定义的宏。</li>
<li>引用是 <code>[</code> 和 <code>]</code> (而不是 <code>'</code> 和 <code>'</code>)。</li>
<li>也因此在 Shell 中做比较使用 <code>test</code> ，而不是 <code>[</code> 。</li>
</ul>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #5317ac;">if</span> test <span style="color: #2544bb;">"$x"</span> = <span style="color: #2544bb;">"$y"</span>; <span style="color: #5317ac;">then</span> ...
</pre>
</div>
<ul class="org-ul">
<li>使用 <code>AC_DEFUN</code> 定义宏。</li>
</ul>
<pre class="example">
AC_DEFUN([NAME1], [Harry, Jr.])
AC_DEFUN([NAME2], [Sally])
AC_DEFUN([MET], [$1 met $2])
MET([NAME1], [NAME2])
</pre>
</div>
</div>

<div id="outline-container-org0af2a4b" class="outline-3">
<h3 id="org0af2a4b"><span class="section-number-3">4.4.</span> 一个 configure.ac 的结构</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #505050;"># </span><span style="color: #505050;">Prelude</span>
<span style="color: #721045;">AC_INIT</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>PACKAGE<span style="color: #a8007f;">]</span>, <span style="color: #a8007f;">[</span>VERSION<span style="color: #a8007f;">]</span>, <span style="color: #a8007f;">[</span>BUG-REPORT-ADDRESS<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
<span style="color: #721045;">AM_INIT_AUTOMAKE</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>foreign -Wall -Werror<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
<span style="color: #721045;">AC_PREREQ</span><span style="color: #000000;">(</span>VERSION<span style="color: #000000;">)</span> <span style="color: #505050;">#  </span><span style="color: #505050;">Eg. AC_PREREQ([2.65])</span>
<span style="color: #721045;">AC_CONFIG_SRCDIR</span><span style="color: #000000;">(</span>FILE<span style="color: #000000;">)</span> <span style="color: #505050;"># </span><span style="color: #505050;">Eg. AC_CONFIG_SRCDIR([src/main.c])</span>
<span style="color: #721045;">AC_CONFIG_AUX_DIR</span><span style="color: #000000;">(</span>DIRECTORY<span style="color: #000000;">)</span> <span style="color: #505050;"># </span><span style="color: #505050;">mising, install-sh &#31561;&#20020;&#26102;&#25991;&#20214;&#30340;&#30446;&#24405; eg. AC_CONFIG_AUX_DIR([build-aux])</span>

<span style="color: #505050;"># </span><span style="color: #505050;">Checks for programs.</span>
AC_PROG_CC
AC_PROG_CXX
AC_PROG_AWK
<span style="color: #721045;">AC_CHECK_PROGS</span><span style="color: #000000;">(</span>VAR, PROGS, <span style="color: #a8007f;">[</span>VAL-IF-NOT-FOUND<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span> <span style="color: #505050;"># </span><span style="color: #505050;">Dene VAR to the rst PROGS found, or to VAL-IF-NOT-FOUND otherwise.</span>

<span style="color: #505050;"># </span><span style="color: #505050;">Check for libraries.</span>
<span style="color: #721045;">AC_CHECK_LIB</span><span style="color: #000000;">(</span>LIBRARY, FUNCT, <span style="color: #a8007f;">[</span>ACT-IF-FOUND<span style="color: #a8007f;">]</span>, <span style="color: #a8007f;">[</span>ACT-IF-NOT<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span> <span style="color: #505050;"># </span><span style="color: #505050;">Check whether LIBRARY exists and contains FUNCT. AC CHECK HEADERS(HEADERS...)Execute ACT-IF-FOUND if it does, ACT-IF-NOT otherwise</span>

<span style="color: #505050;"># </span><span style="color: #505050;">Check for header files.</span>
<span style="color: #721045;">AC_CHECK_HEADERS</span><span style="color: #000000;">(</span>HEADERS...<span style="color: #000000;">)</span> <span style="color: #505050;"># </span><span style="color: #505050;">Check for HEADERS and #define HAVE_HEADER_H for each header found. eg. AC_CHECK_HEADERS([sys/param.h unistd.h])</span>

<span style="color: #505050;"># </span><span style="color: #505050;">Check for typedefs, structures, and compiler characteristics.</span>

<span style="color: #505050;"># </span><span style="color: #505050;">Check for library functions.</span>

<span style="color: #505050;"># </span><span style="color: #505050;">Output files.</span>
<span style="color: #721045;">AC_CONFIG_HEADERS</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>config.h<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
<span style="color: #721045;">AC_CONFIG_FILES</span><span style="color: #000000;">(</span><span style="color: #a8007f;">[</span>Makefile src/Makefile ...<span style="color: #a8007f;">]</span><span style="color: #000000;">)</span>
AC_OUTPUT
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org63dafd9" class="outline-2">
<h2 id="org63dafd9"><span class="section-number-2">5.</span> 使用 Automake</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgd501f2d" class="outline-3">
<h3 id="orgd501f2d"><span class="section-number-3">5.1.</span> Automake 规则</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Automake helps creating <b><b>portable</b></b> and <b>*GNU-standard compliant</b> *Makefile*s.
<ul class="org-ul">
<li>You may be used to other kinds of build systems.(eg. no VPATH builds, but all objects go into <b>obj/</b>).</li>
<li>Do not use Automake if you do not like the GNU Build System: Automake will get in your way if you don't fit the mold.</li>
</ul></li>
<li>"automake" creates <b><b>complex</b></b> *Makefile.in*s from simple *Makefile.am*s.
<ul class="org-ul">
<li>Consider *Makefile.in*s as internal details.</li>
</ul></li>
<li>*Makele.am*s follow roughly the same syntax as *Makefile*s however they usually contains only variable denitions.
<ul class="org-ul">
<li>"automake"" creates build rules from these definitions.</li>
<li>It's OK to add extra <b>Makefile</b> rules in <b>Makefile.am</b>: "automake" will preserve them in the output.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgacce477" class="outline-3">
<h3 id="orgacce477"><span class="section-number-3">5.2.</span> 在 <b>configure.ac</b> 中声明 Automake</h3>
<div class="outline-text-3" id="text-5-2">
<p>
语法: <code>AM_INIT_AUTOMAKE([OPTIONS...])])</code> . eg: <code>AM_INIT_AUTOMAKE([foreign -Wall -Werror])</code> .
</p>

<p>
选项:
</p>

<ul class="org-ul">
<li><code>-Wall</code> : 关闭所有警告.</li>
<li><code>-Werror</code> : 把警告当成错误.</li>
<li><code>foreign</code> : 放宽 GNU 标准要求.</li>
<li><code>1.11.1</code> : automake 的最小版本号</li>
<li><code>dist-bzip2</code> : Also create tar.bz2 archives during <code>make dist</code> and <code>make distcheck</code>.</li>
<li><code>tar-ustar</code> :  Create tar archives using the ustar format.</li>
</ul>

<p>
<code>AC_CONFIG_FILES(FILES...)</code> : Automake 为每一个有 <b>FILE</b>.am 的 <b>FILE</b> 生成一个 <b>FILE</b>.in 文件。
</p>

<p>
eg: <code>AC_CONFIG_FILES([Makefile sub/Makefile])</code> 会生成 <b>Makefile.am</b> 和 <b>sub/Makefile.am</b>.
</p>
</div>
</div>

<div id="outline-container-orgede369a" class="outline-3">
<h3 id="orgede369a"><span class="section-number-3">5.3.</span> 声明源文件</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">bin_PROGRAMS</span> = foo run-me
<span style="color: #00538b;">foo_SOURCES</span> = foo.c foo.h print.c print.h
<span style="color: #00538b;">run_me_SOURCES</span> = run.c run.h print.c
</pre>
</div>

<ul class="org-ul">
<li>These programs will be installed in $(bindir).</li>
<li>The sources of each <b>program</b> go into *program*_SOURCES.</li>
<li>Non-alphanumeric characters are mapped to '_'.</li>
<li>Automake automatically computes the list of objects to build and link from these files.</li>
<li>Header files are not compiled. We list them only so they get distributed (Automake does not distribute files it does not know about).</li>
<li>It's OK to use the same source for two programs.</li>
<li>Compiler and linker are inferred from the extensions.</li>
</ul>
</div>
</div>

<div id="outline-container-org7764c6a" class="outline-3">
<h3 id="org7764c6a"><span class="section-number-3">5.4.</span> (静态)库</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">lib_LIBRARIES</span> = libfoo.a libbar.a
<span style="color: #00538b;">libfoo_a_SOURCES</span> = foo.c privfoo.h
<span style="color: #00538b;">libbar_a_SOURCES</span> = bar.c privbar.h
<span style="color: #00538b;">include_HEADERS</span> = foo.h bar.h
</pre>
</div>

<ul class="org-ul">
<li>These libraries will be installed in $(libdir).</li>
<li>Library names must match lib*.a.</li>
<li>Public headers will be installed in $(includedir).</li>
<li>Private headers are not installed, like ordinary source files.</li>
</ul>
</div>
</div>

<div id="outline-container-org07966af" class="outline-3">
<h3 id="org07966af"><span class="section-number-3">5.5.</span> 目录结构</h3>
<div class="outline-text-3" id="text-5-5">
<ul class="org-ul">
<li>在每个目录下都要有一个 <b>Makefile</b> (也就是 <b>Makefile.am</b>)。</li>
<li>所有的 <b>Makefile</b> 都要在 <b>configure.ac</b> 中声明.</li>
</ul>
<pre class="example">
AC_CONFIG_FILES([Makefile lib/Makefile src/Makefile src/dira/Makefile src/dirb/Makefile])
</pre>
<ul class="org-ul">
<li>在顶层目录下运行 make.</li>
<li><b>Makefile.am*s should fix the order in which to recurse directories using the *SUBDIRS</b> variable.</li>
</ul>
<pre class="example">
file: Makefile.am
SUBDIRS = lib src
</pre>
<ul class="org-ul">
<li>The current directory is implicitly built after subdirectories.</li>
<li>You can put: .' where you want to override this.</li>
</ul>
</div>
</div>

<div id="outline-container-orgbe71170" class="outline-3">
<h3 id="orgbe71170"><span class="section-number-3">5.6.</span> $(srcdir) and VPATH Builds</h3>
<div class="outline-text-3" id="text-5-6">
<ul class="org-ul">
<li>Remember VPATH builds: a source file is not necessary in the current directory.</li>
<li>There are two twin trees: the <b><b>build tree</b></b>, and the <b><b>source tree</b></b>.</li>
<li><b>Makefile</b> and objects files are in the build tree.</li>
<li><b>Makefile.in</b>, <b>Makefile.am</b>, and source files are in the source tree.</li>
<li>If <code>./configure</code> is run in the current directory, the two trees are one.</li>
<li>In each <b>Makefile</b>, 'config.status' will define <code>$(srcdir)</code>: the path to the matching source directory.</li>
<li>When referring to sources files or targets in Automake variables, you do not have to worry about <b>source</b> vs. <b>build</b>, because 'make' will check both directories.</li>
<li>You may need <code>$(srcdir)</code> when specifying flags for tools, or writing custom commands. E.g., to tell the compiler to include headers from <b>dir/</b> , you should write <code>-I$(srcdir)/dir</code>, not <code>-Idir</code>. (<code>-Idir</code> would fetch headers from the build tree.)</li>
</ul>
</div>
</div>

<div id="outline-container-orgf40677d" class="outline-3">
<h3 id="orgf40677d"><span class="section-number-3">5.7.</span> Convenience Libraries</h3>
<div class="outline-text-3" id="text-5-7">
<p>
<b>lib/Makefile.am</b>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">noinst_LIBRARIES</span> = libcompat.a
<span style="color: #00538b;">libcompat_a_SOURCES</span> = xalloc.c xalloc.h
</pre>
</div>

<p>
<b>src/Makefile.am</b>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">bin_PROGRAMS</span> = foo run-me
<span style="color: #00538b;">foo_SOURCES</span> = foo.c foo.h print.c print.h
<span style="color: #00538b;">run_me_SOURCES</span> = run.c run.h print.c
<span style="color: #00538b;">run_me_LDADD</span> = ../lib/libcompat.a
<span style="color: #00538b;">run_me_CPPFLAGS</span> = -I$<span style="color: #000000;">(</span>srcdir<span style="color: #000000;">)</span>/../lib
</pre>
</div>

<ul class="org-ul">
<li>This is a convenience library, used only when building the package.</li>
<li><b>LDADD</b> is added when linking all programs.</li>
<li><b>AM_CPPFLAGS</b> contains additional preprocessor flags.</li>
<li>You can use per-target variables: they apply to a single program</li>
</ul>
</div>
</div>

<div id="outline-container-orgf59846e" class="outline-3">
<h3 id="orgf59846e"><span class="section-number-3">5.8.</span> Per-Target Flags</h3>
<div class="outline-text-3" id="text-5-8">
<p>
Assuming foo is a program or library:
</p>

<ul class="org-ul">
<li><code>foo_CFLAGS</code> : Additional C compiler flags.</li>
<li><code>foo_CPPFLAGS</code> : Additional preprocessor flags (<code>-Is</code> and <code>-Ds</code>).</li>
<li><code>foo_LDADD</code> : Additional link objects, <code>-ls</code> and <code>-Ls</code> (if <b>foo</b> is a program).</li>
<li><code>foo_LIBADD</code> : Additional link objects, <code>-ls</code> and <code>-Ls</code> (if <b>foo</b> is a library).</li>
<li><code>foo_LDFLAGS</code> : Additional linker flags.</li>
</ul>

<p>
The default value for <code>foo_XXXFLAGS</code> is <code>$(AM_XXXFLAGS)</code>.
</p>

<p>
Use plain file names to refer to libraries inside your package (keep <code>-ls</code> and <code>-Ls</code> for external libraries only).
</p>

<p>
<b>src/Makefile.am</b>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #00538b;">bin_PROGRAMS</span> = foo run-me
<span style="color: #00538b;">foo_SOURCES</span> = foo.c foo.h print.c print.h
<span style="color: #00538b;">run_me_SOURCES</span> = run.c run.h print.c
<span style="color: #00538b;">run_me_CPPFLAGS</span> = -I$<span style="color: #000000;">(</span>srcdir<span style="color: #000000;">)</span>/../lib
<span style="color: #00538b;">run_me_LDADD</span> = ../lib/libcompat.a $<span style="color: #000000;">(</span>EFENCELIB<span style="color: #000000;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7516450" class="outline-3">
<h3 id="org7516450"><span class="section-number-3">5.9.</span> What Gets Distributed</h3>
<div class="outline-text-3" id="text-5-9">
<p>
<code>make dist</code> and <code>make distcheck</code> create a tarball containing:
</p>

<ul class="org-ul">
<li>All sources declared using &#x2026; <b>SOURCES</b></li>
<li>All headers declared using &#x2026; <b>HEADERS</b></li>
<li>All scripts declared with <b>dist &#x2026; SCRIPTS</b></li>
<li>All data les declared with <b>dist &#x2026; DATA</b></li>
<li>&#x2026;</li>
<li>Common les such as <b>ChangeLog</b>, <b>NEWS</b>, etc.</li>
<li>See <code>automake --help</code> for a list of those files.</li>
<li>Extra les or directories listed into <b>EXTRA_DIST</b>.</li>
</ul>
</div>
</div>

<div id="outline-container-orgdeb3c23" class="outline-3">
<h3 id="orgdeb3c23"><span class="section-number-3">5.10.</span> 扩展的 Automake 规则</h3>
<div class="outline-text-3" id="text-5-10">
<p>
略。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="postamble">First created: 2017-12-04 11:38:52 <br />Last updated: 2022-08-23 Tue 18:22 <br />Power by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.5.4)</p>
</div>
</body>
</html>
