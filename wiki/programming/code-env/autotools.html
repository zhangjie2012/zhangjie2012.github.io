<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-09-06 Fri 11:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="JerryZhang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<p>
&#x2014;
title: "AutoTools"
collection: 'C/C++'
date: 2017-12-04 11:38:52
layout: page
&#x2014;
</p>

<p>
[TOC]
</p>

<p>
<b><b>本文档整理自: [Autotools Tutorial: Part II](<a href="https://www.lrde.epita.fr/~adl/dl/autotools.pdf">https://www.lrde.epita.fr/~adl/dl/autotools.pdf</a>)。</b></b>
</p>

<p>
## 一、Hello World
</p>

<p>
### 1.1 创建文件
</p>

<p>
<b>src/main.c</b>
</p>

<p>
#include &lt;config.h&gt;
#include &lt;stdio.h&gt;
</p>

<p>
int main(void)
{
    puts ("Hello World!");
    puts ("This is " PACKAGE<sub>STRING</sub> ".");
    return 0;
}
</p>


<p>
<b>configure.ac</b>
</p>

<p>
AC<sub>INIT</sub>([amhello], [1.0], [bug-report@address])
AM<sub>INIT</sub><sub>AUTOMAKE</sub>([foreign -Wall -Werror])
AC<sub>PROG</sub><sub>CC</sub>
AC<sub>CONFIG</sub><sub>HEADER</sub>([config.h])
AC<sub>CONFIG</sub><sub>FILES</sub>([Makefile src/Makefile])
AC<sub>OUTPUT</sub>
</p>

<p>
<b>Makefile.am</b>
</p>

<p>
SUBDIRS = src
</p>

<p>
<b>src/Makefile.am</b>
</p>

<p>
bin<sub>PROGRAMS</sub> = hello
hello<sub>SOURCES</sub> = main.c
</p>

<p>
此时的文件结构为(`ls -R`):
</p>

<p>
.:
Makefile.am  configure.ac  src
</p>

<p>
src:
Makefile.am  main.c
</p>


<p>
### 1.2 autoreconf &#x2013;install
</p>

<p>
$: autoreconf &#x2013;install
configure.ac:2: installing `./install-sh'
configure.ac:2: installing `./missing'
src/Makefile.am: installing `./depcomp'
</p>

<p>
此时的文件结构为(`ls -R`):
</p>

<p>
.:
Makefile.am  aclocal.m4      config.h.in  configure.ac  install-sh  src
Makefile.in  autom4te.cache  configure    depcomp       missing
</p>

<p>
autom4te.cache:
output.0  output.1  requests  traces.0  traces.1
</p>

<p>
src:
Makefile.am  Makefile.in  main.c
</p>

<ul class="org-ul">
<li>Makefile.in config.h.in configure* src/Makefile.in : expected configuration templates.</li>
<li>aclocal.m4 : denitions for third-party macros used in <b>configure.ac</b>.</li>
<li>depcomp* install-sh* missing* : auxiliary tools used during the build.</li>
<li>autom4te.cache/ autom4te.cache/* : Autotools cache files</li>
</ul>

<p>
### 1.3 `./configure`
</p>

<p>
checking for a BSD-compatible install&#x2026; /usr/bin/install -c
checking whether build environment is sane&#x2026; yes
checking for a thread-safe mkdir -p&#x2026; /bin/mkdir -p
checking for gawk&#x2026; gawk
checking whether make sets $(MAKE)&#x2026; yes
checking for gcc&#x2026; gcc
&#x2026;
configure: creating ./config.status
config.status: creating Makefile
config.status: creating src/Makefile
config.status: creating config.h
config.status: executing depfiles commands
</p>

<p>
### 1.4 `make`
</p>

<p>
/usr/bin/make  all-recursive
make[1]: Entering directory `/home/zhangjie/TempFile/src'
Making all in src
make[2]: Entering directory `/home/zhangjie/TempFile/src/src'
gcc -DHAVE<sub>CONFIG</sub><sub>H</sub> -I. -I..     -g -O2 -MT main.o -MD -MP -MF .deps/main.Tpo -c -o main.o main.c
mv -f .deps/main.Tpo .deps/main.Po
gcc  -g -O2   -o hello main.o
make[2]: Leaving directory `/home/zhangjie/TempFile/src/src'
make[2]: Entering directory `/home/zhangjie/TempFile/src'
make[2]: Leaving directory `/home/zhangjie/TempFile/src'
make[1]: Leaving directory `/home/zhangjie/TempFile/src'
</p>

<p>
### 1.5 编译、链接成功，运行程序: `src/hello`
</p>

<p>
$: src/hello
Hello World!
This is amhello 1.0.
</p>

<p>
### 1.6 源码打包: `make distcheck`
</p>

<p>
$: make distcheck
&#x2026;
<code>===========================================</code>
amhello-1.0 archives ready for distribution:
amhello-1.0.tar.gz
<code>===========================================</code>
</p>

<p>
### 1.7 解包，查看文件内容
</p>

<p>
$ tar ztf amhello-1.0.tar.gz
amhello-1.0/
amhello-1.0/Makefile.am
amhello-1.0/aclocal.m4
amhello-1.0/configure.ac
amhello-1.0/src/
amhello-1.0/src/Makefile.am
amhello-1.0/src/main.c
amhello-1.0/src/Makefile.in
amhello-1.0/config.h.in
amhello-1.0/Makefile.in
amhello-1.0/missing
amhello-1.0/configure
amhello-1.0/depcomp
amhello-1.0/install-sh
</p>

<p>
## 二、Autotools 核心介绍
</p>

<p>
### 2.1 GNU AutoConf
</p>

<ul class="org-ul">
<li>`autoconf` : Create <b>configure</b> from <b>configure.ac</b> .</li>
<li>`autoheader` : Create <b>config.h.in</b> from <b>configure.ac</b> .</li>
<li>`autoreconf` : Run all tools in the right order.</li>
<li>`autoscan` : Scan sources for common portability problems, and related macros missing from <b>configure.ac</b> .</li>
<li>`autoupdate` : Update obsolete macros in <b>configure.ac</b> .</li>
<li>`ifnames` : Gather identiers from all `#if/#ifdef/&#x2026;` directives.</li>
<li>`autom4te` :  The heart of Autoconf. It drives M4 and implements the</li>
</ul>
<p>
features used by most of the above tools. Useful for
creating more than just <b>configure</b> files.
</p>

<p>
### 2.2 GNU AutoMake
</p>

<ul class="org-ul">
<li>`automake` : Create <b>Makefile.in*s from *Makefile.am*s and *configure.ac</b> .</li>
<li>`aclocal` : Scan `configure.ac` for uses of third-party macros, and</li>
</ul>
<p>
gather denitions in `aclocal.m4`.
</p>

<p>
### 2.3 autoreconf
</p>

<p>
![autoreconf](/attach/compile/autoreconf.jpg)
</p>

<p>
在实际应用中:
</p>

<ul class="org-ul">
<li>没必要记住所有工具之间的关系；</li>
<li>在初始化的时候，使用 `autoreconf &#x2013;install`；</li>
<li>修改输出(配置)文件的时候，重建规则；</li>
<li>你需对解每个工具产生的错误都有一个粗糙的理解（至少要知道是谁产生的错误）。</li>
</ul>

<p>
## 三、Hello World 讲解
</p>

<p>
### 3.1 configure.ac
</p>

<p>
AC<sub>INIT</sub>([amhello], [1.0], [bug-report@address])
AM<sub>INIT</sub><sub>AUTOMAKE</sub>([foreign -Wall -Werror])
AC<sub>PROG</sub><sub>CC</sub>
AC<sub>CONFIG</sub><sub>HEADER</sub>([config.h])
AC<sub>CONFIG</sub><sub>FILES</sub>([Makefile src/Makefile])
AC<sub>OUTPUT</sub>
</p>

<ul class="org-ul">
<li>`AC<sub>INIT</sub>`: Initialize <b>Autoconf</b>. Specify package's name, version number, and bug-report address.</li>
<li>`AM<sub>INIT</sub><sub>AUTOMAKE</sub>`: Initialize <b>Automake</b>. Turn on all Automake warnning and report them as errors. This is a foreign package.</li>
<li>`AC<sub>PROG</sub><sub>CC</sub>`: Check for a C compiler.</li>
<li>`AC<sub>CONFIG</sub><sub>HEADER</sub>([config.h])`: Declare <b>config.h</b> as output header.</li>
<li>`AC<sub>CONFIG</sub><sub>FILES</sub>`: Declare <b>Makefile</b> and <b>src/Makefile</b> as output files.</li>
<li>`AC<sub>OUTPUT</sub>`: Actually output all declared files.</li>
</ul>

<p>
### 3.2 Makefile.am
</p>

<p>
SUBDIRS = src
</p>

<ul class="org-ul">
<li>Build recursively in <b>src/</b> .</li>
<li>Nothing else is declared for the current directory.(The top-level <b>Makefile.am</b> is usually short.)</li>
</ul>

<p>
### 3.2 src/Makefile.am
</p>

<p>
bin<sub>PROGRAMS</sub> = hello
hello<sub>SOURCES</sub> = main.c
</p>

<ul class="org-ul">
<li>We are building some programs.</li>
<li>These programs will be installed in <b>bindir</b> (注意看下面tip的结构).</li>
<li>There is only one program to build: <b>hello</b>.</li>
<li>To create <b>hello</b>, just compile <b>main.c</b>.</li>
</ul>

<p>
<b><b>tip</b></b>: Standard File System Hierarchy:
</p>

<p>
![](/attach/compile/sys<sub>hierarchy.jpg</sub>)
</p>

<p>
## 四、使用 Autoconf
</p>

<p>
### 4.1 从 configure.ac 到 configure 和 config.h.in
</p>

<ul class="org-ul">
<li>"autoconf is a macro processor.</li>
<li>It converts <b>configure.ac</b>, which is a shell script using macro instructions, into <b>congfiure</b>, a full-fledged shell script.</li>
<li>Autoconf offers many macros to perform common conguration checks.</li>
<li>It is not uncommon to have a <b>configure.ac</b> without shell construct, using only macros.</li>
<li>While processing <b>configure.ac</b> it is also possible to trace the occurrences of macros. This is how "autoheader" creates <b>config.h.in</b> . It just looks for the macros that #define symbols.</li>
<li>The real macro processor actually is GNU M4. Autoconf offers some infrastructure on top of that, plus the pool of macros.</li>
</ul>

<p>
### 4.2 探索 M4
</p>

<p>
<b>exmple.m4:</b>
</p>

<p>
m4<sub>define</sub>(NAME1, Harry)
m4<sub>define</sub>(NAME2, Sally)
m4<sub>define</sub>(MET, $1 met $2)
MET(NAME1, NAME2)
</p>

<p>
output:
</p>

<p>
$: m4 -P example.m4
</p>

<p>
Harry met Sally
</p>

<p>
M4 是一个宏处理器，将输出拷贝到输出。可以内嵌，也可以用户自定义，除了宏展开以外，M4还有一些内建的函数，用来引用文件、执行Unix命令、文本操作、循环等。
</p>

<p>
这里不详细展开表述 M4，但是要记住 M4 是 Autoconf 的核心，Autoconf 只是封装了一些指令而已。
</p>

<p>
### 4.3 M4 基础上的 Autoconf
</p>

<ul class="org-ul">
<li>在许多机器上， Auto = M4，和一些预定义的宏。</li>
<li>引用是 `[` 和 `]` (而不是 `'` 和 `'`)。</li>
<li><p>
也因此在 Shell 中做比较使用 `test` ，而不是 `[` 。
</p>

<p>
if test "$x" = "$y"; then &#x2026;
</p></li>

<li><p>
使用 `AC<sub>DEFUN</sub>` 定义宏。
</p>

<p>
AC<sub>DEFUN</sub>([NAME1], [Harry, Jr.])
AC<sub>DEFUN</sub>([NAME2], [Sally])
AC<sub>DEFUN</sub>([MET], [$1 met $2])
MET([NAME1], [NAME2])
</p></li>
</ul>


<p>
### 4.3 一个 configure.ac 的结构
</p>

<p>
AC<sub>INIT</sub>([PACKAGE], [VERSION], [BUG-REPORT-ADDRESS])
AM<sub>INIT</sub><sub>AUTOMAKE</sub>([foreign -Wall -Werror])
AC<sub>PREREQ</sub>(VERSION) #  Eg. AC<sub>PREREQ</sub>([2.65])
AC<sub>CONFIG</sub><sub>SRCDIR</sub>(FILE) # Eg. AC<sub>CONFIG</sub><sub>SRCDIR</sub>([src/main.c])
AC<sub>CONFIG</sub><sub>AUX</sub><sub>DIR</sub>(DIRECTORY) # mising, install-sh 等临时文件的目录 eg. AC<sub>CONFIG</sub><sub>AUX</sub><sub>DIR</sub>([build-aux])
</p>

<p>
AC<sub>PROG</sub><sub>CC</sub>
AC<sub>PROG</sub><sub>CXX</sub>
AC<sub>PROG</sub><sub>AWK</sub>
AC<sub>CHECK</sub><sub>PROGS</sub>(VAR, PROGS, [VAL-IF-NOT-FOUND]) # Dene VAR to the rst PROGS found, or to VAL-IF-NOT-FOUND otherwise.
</p>

<p>
AC<sub>CHECK</sub><sub>LIB</sub>(LIBRARY, FUNCT, [ACT-IF-FOUND], [ACT-IF-NOT]) # Check whether LIBRARY exists and contains FUNCT. AC CHECK HEADERS(HEADERS&#x2026;)Execute ACT-IF-FOUND if it does, ACT-IF-NOT otherwise
</p>

<p>
AC<sub>CHECK</sub><sub>HEADERS</sub>(HEADERS&#x2026;) # Check for HEADERS and #define HAVE<sub>HEADER</sub><sub>H</sub> for each header found. eg. AC<sub>CHECK</sub><sub>HEADERS</sub>([sys/param.h unistd.h])
</p>

<p>
AC<sub>CONFIG</sub><sub>HEADERS</sub>([config.h])
AC<sub>CONFIG</sub><sub>FILES</sub>([Makefile src/Makefile &#x2026;])
AC<sub>OUTPUT</sub>
</p>


<p>
## 五、使用 Automake
</p>

<p>
### 5.1 Automake 规则
</p>

<ul class="org-ul">
<li>Automake helps creating <b><b>portable</b></b> and <b>*GNU-standard compliant</b> *Makefile*s.
<ul class="org-ul">
<li>You may be used to other kinds of build systems.(eg. no VPATH builds, but all objects go into <b>obj/</b>).</li>
<li>Do not use Automake if you do not like the GNU Build System: Automake will get in your way if you don't fit the mold.</li>
</ul></li>
<li>"automake" creates <b><b>complex</b></b> *Makefile.in*s from simple *Makefile.am*s.
<ul class="org-ul">
<li>Consider *Makefile.in*s as internal details.</li>
</ul></li>
<li>*Makele.am*s follow roughly the same syntax as *Makefile*s however they usually contains only variable denitions.
<ul class="org-ul">
<li>"automake"" creates build rules from these definitions.</li>
<li>It's OK to add extra <b>Makefile</b> rules in <b>Makefile.am</b>: "automake" will preserve them in the output.</li>
</ul></li>
</ul>

<p>
### 5.2 在 <b>configure.ac</b> 中声明 Automake
</p>

<p>
语法: `AM<sub>INIT</sub><sub>AUTOMAKE</sub>([OPTIONS&#x2026;])])` . eg: `AM<sub>INIT</sub><sub>AUTOMAKE</sub>([foreign -Wall -Werror])` .
</p>

<p>
选项:
</p>

<ul class="org-ul">
<li>`-Wall` : 关闭所有警告.</li>
<li>`-Werror` : 把警告当成错误.</li>
<li>`foreign` : 放宽 GNU 标准要求.</li>
<li>`1.11.1` : automake 的最小版本号</li>
<li>`dist-bzip2` : Also create tar.bz2 archives during `make dist` and `make distcheck`.</li>
<li>`tar-ustar` :  Create tar archives using the ustar format.</li>
</ul>

<p>
`AC<sub>CONFIG</sub><sub>FILES</sub>(FILES&#x2026;)` : Automake 为每一个有 <b>FILE</b>.am 的 <b>FILE</b> 生成一个 <b>FILE</b>.in 文件。
</p>

<p>
eg: `AC<sub>CONFIG</sub><sub>FILES</sub>([Makefile sub/Makefile])` 会生成 <b>Makefile.am</b> 和 <b>sub/Makefile.am</b>.
</p>

<p>
### 5.3 声明源文件
</p>

<p>
bin<sub>PROGRAMS</sub> = foo run-me
foo<sub>SOURCES</sub> = foo.c foo.h print.c print.h
run<sub>me</sub><sub>SOURCES</sub> = run.c run.h print.c
</p>

<ul class="org-ul">
<li>These programs will be installed in $(bindir).</li>
<li>The sources of each <b>program</b> go into *program*<sub>SOURCES</sub>.</li>
<li>Non-alphanumeric characters are mapped to '_'.</li>
<li>Automake automatically computes the list of objects to build and link from these files.</li>
<li>Header files are not compiled. We list them only so they get distributed (Automake does not distribute files it does not know about).</li>
<li>It's OK to use the same source for two programs.</li>
<li>Compiler and linker are inferred from the extensions.</li>
</ul>

<p>
### 5.4 (静态)库
</p>

<p>
lib<sub>LIBRARIES</sub> = libfoo.a libbar.a
libfoo<sub>a</sub><sub>SOURCES</sub> = foo.c privfoo.h
libbar<sub>a</sub><sub>SOURCES</sub> = bar.c privbar.h
include<sub>HEADERS</sub> = foo.h bar.h
</p>

<ul class="org-ul">
<li>These libraries will be installed in $(libdir).</li>
<li>Library names must match lib*.a.</li>
<li>Public headers will be installed in $(includedir).</li>
<li>Private headers are not installed, like ordinary source files.</li>
</ul>

<p>
### 5.5 目录结构
</p>

<ul class="org-ul">
<li>在每个目录下都要有一个 <b>Makefile</b> (也就是 <b>Makefile.am</b>)。</li>
<li><p>
所有的 <b>Makefile</b> 都要在 <b>configure.ac</b> 中声明.
</p>

<p>
AC<sub>CONFIG</sub><sub>FILES</sub>([Makefile lib/Makefile src/Makefile src/dira/Makefile src/dirb/Makefile])
</p></li>

<li>在顶层目录下运行 make.</li>
<li><p>
<b>Makefile.am*s should fix the order in which to recurse directories using the *SUBDIRS</b> variable.
</p>

<p>
file: Makefile.am
SUBDIRS = lib src
</p></li>

<li>The current directory is implicitly built after subdirectories.</li>
<li>You can put: .' where you want to override this.</li>
</ul>

<p>
### 5.6 $(srcdir) and VPATH Builds
</p>

<ul class="org-ul">
<li>Remember VPATH builds: a source file is not necessary in the current directory.</li>
<li>There are two twin trees: the <b><b>build tree</b></b>, and the <b><b>source tree</b></b>.</li>
<li><b>Makefile</b> and objects files are in the build tree.</li>
<li><b>Makefile.in</b>, <b>Makefile.am</b>, and source files are in the source tree.</li>
<li>If `./configure` is run in the current directory, the two trees are one.</li>
<li>In each <b>Makefile</b>, 'config.status' will define `$(srcdir)`: the path to the matching source directory.</li>
<li>When referring to sources files or targets in Automake variables, you do not have to worry about <b>source</b> vs. <b>build</b>, because 'make' will check both directories.</li>
<li>You may need `\((srcdir)` when specifying flags for tools, or writing custom commands. E.g., to tell the compiler to include headers from *dir/* , you should write `-I\)(srcdir)/dir`, not `-Idir`. (`-Idir` would fetch headers from the build tree.)</li>
</ul>

<p>
### 5.7 Convenience Libraries
</p>

<p>
<b>lib/Makefile.am</b>:
</p>

<p>
noinst<sub>LIBRARIES</sub> = libcompat.a
libcompat<sub>a</sub><sub>SOURCES</sub> = xalloc.c xalloc.h
</p>

<p>
<b>src/Makefile.am</b>:
</p>

<p>
bin<sub>PROGRAMS</sub> = foo run-me
foo<sub>SOURCES</sub> = foo.c foo.h print.c print.h
run<sub>me</sub><sub>SOURCES</sub> = run.c run.h print.c
run<sub>me</sub><sub>LDADD</sub> = ../lib/libcompat.a
run<sub>me</sub><sub>CPPFLAGS</sub> = -I$(srcdir)/../lib
</p>

<ul class="org-ul">
<li>This is a convenience library, used only when building the package.</li>
<li><b>LDADD</b> is added when linking all programs.</li>
<li><b>AM<sub>CPPFLAGS</sub></b> contains additional preprocessor flags.</li>
<li>You can use per-target variables: they apply to a single program</li>
</ul>

<p>
### 5.8 Per-Target Flags
</p>

<p>
Assuming foo is a program or library:
</p>

<ul class="org-ul">
<li>`foo<sub>CFLAGS</sub>` : Additional C compiler flags.</li>
<li>`foo<sub>CPPFLAGS</sub>` : Additional preprocessor flags (`-Is` and `-Ds`).</li>
<li>`foo<sub>LDADD</sub>` : Additional link objects, `-ls` and `-Ls` (if <b>foo</b> is a program).</li>
<li>`foo<sub>LIBADD</sub>` : Additional link objects, `-ls` and `-Ls` (if <b>foo</b> is a library).</li>
<li>`foo<sub>LDFLAGS</sub>` : Additional linker flags.</li>
</ul>

<p>
The default value for `foo<sub>XXXFLAGS</sub>` is `$(AM<sub>XXXFLAGS</sub>)`.
</p>

<p>
Use plain file names to refer to libraries inside your package (keep `-ls` and `-Ls` for external libraries only).
</p>

<p>
<b>src/Makefile.am</b>:
</p>

<p>
bin<sub>PROGRAMS</sub> = foo run-me
foo<sub>SOURCES</sub> = foo.c foo.h print.c print.h
run<sub>me</sub><sub>SOURCES</sub> = run.c run.h print.c
run<sub>me</sub><sub>CPPFLAGS</sub> = -I$(srcdir)/../lib
run<sub>me</sub><sub>LDADD</sub> = ../lib/libcompat.a $(EFENCELIB)
</p>

<p>
### 5.9 What Gets Distributed
</p>

<p>
`make dist` and `make distcheck` create a tarball containing:
</p>

<ul class="org-ul">
<li>All sources declared using &#x2026; <b>SOURCES</b></li>
<li>All headers declared using &#x2026; <b>HEADERS</b></li>
<li>All scripts declared with <b>dist &#x2026; SCRIPTS</b></li>
<li>All data les declared with <b>dist &#x2026; DATA</b></li>
<li>&#x2026;</li>
<li>Common les such as <b>ChangeLog</b>, <b>NEWS</b>, etc.</li>
<li>See `automake &#x2013;help` for a list of those files.</li>
<li>Extra les or directories listed into <b>EXTRA<sub>DIST</sub></b>.</li>
</ul>

<p>
### 5.10 扩展的 Automake 规则
</p>

<p>
略。
</p>
</div>
<div id="postamble" class="status">
<p class="author">Author: JerryZhang</p>
<p class="date">Created: 2019-09-06 Fri 11:28</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
