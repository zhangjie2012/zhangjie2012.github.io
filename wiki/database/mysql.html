<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-08-23 Tue 18:44 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MySQL</title>
<meta name="author" content="DESKTOP-ZHJ" />
<meta name="description" content="Keep It Simple, Stupid" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="/static/site.css" />
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">MySQL</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgab4844a">1. 安装</a>
<ul>
<li><a href="#org02333d0">1.1. Docker</a></li>
</ul>
</li>
<li><a href="#orgbaea05c">2. Command</a>
<ul>
<li><a href="#org37e3d12">2.1. Database</a></li>
<li><a href="#orgb8f0ee0">2.2. Table</a></li>
<li><a href="#orgbde5db2">2.3. Grant</a></li>
<li><a href="#orgf41d6af">2.4. Backup</a></li>
<li><a href="#org5aef409">2.5. Restore</a></li>
</ul>
</li>
<li><a href="#org472e322">3. Data Type</a>
<ul>
<li><a href="#org3dc3969">3.1. BLOB 和 TEXT</a></li>
</ul>
</li>
<li><a href="#orgfb81776">4. Configure</a>
<ul>
<li><a href="#orgf3ef0fe">4.1. 某公司的 my.cnf 样例</a></li>
<li><a href="#org6342332">4.2. 慢查询</a></li>
<li><a href="#org071f5ba">4.3. Docker MySQL 设置 utf8mb4 编码</a></li>
</ul>
</li>
<li><a href="#orga5acffc">5. Best Practices</a></li>
<li><a href="#org2e1da70">6. Resource</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgab4844a" class="outline-2">
<h2 id="orgab4844a"><span class="section-number-2">1.</span> 安装</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org02333d0" class="outline-3">
<h3 id="org02333d0"><span class="section-number-3">1.1.</span> Docker</h3>
<div class="outline-text-3" id="text-1-1">
<ol class="org-ol">
<li><code>docker pull mysql:5.7</code></li>
<li><code>docker run --name mysql-5 -d --restart=always -e MYSQL_ROOT_PASSWORD=&lt;password&gt; -p 127.0.0.1:3306:3306 mysql:5.7</code></li>
<li><code>docker exec -it mysql-5 mysql -uroot -p&lt;password&gt;</code></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgbaea05c" class="outline-2">
<h2 id="orgbaea05c"><span class="section-number-2">2.</span> Command</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org37e3d12" class="outline-3">
<h3 id="org37e3d12"><span class="section-number-3">2.1.</span> Database</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>建库: <code>CREATE DATABASE db_name charset="utf8mb4"</code></li>
<li>删库: <code>DROP DATABASES db_name</code></li>
<li>查看当前使用的数据库: <code>select database()</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgb8f0ee0" class="outline-3">
<h3 id="orgb8f0ee0"><span class="section-number-3">2.2.</span> Table</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>建表: <code>CREATE TABLE tbl_name (&lt;col_name_1&gt; &lt;TYPE1&gt;2 [,..&lt;col_name_n&gt; &lt;TYPEn&gt;])</code></li>
<li>删表: <code>DROP TABLE tbl_name</code></li>
<li>显示表的结构: <code>desc tbl_name</code>, <code>show columns from tbl_name</code></li>
<li>增加列: <code>ALTER TABLE tbl_name ADD col_name TYPE</code></li>
<li>删除列: <code>ALTER TABLE tbl_name DROP col_name</code></li>
<li>修改列: <code>ALTER TABLE tbl_name MODIFY col_name TYPE</code></li>
<li>改变表的名字: <code>ALTER TABLE tbl_name RENAME new_tbl_name</code></li>
<li>总条目数: <code>SELECT COUNT(*) FROM tbl_name</code></li>
<li>查看建表语句: <code>SHOW CREATE TABLE tbl_name \G</code></li>
</ul>

<p>
索引:
</p>

<ul class="org-ul">
<li>查看索引: <code>show index from tblname</code> or <code>show keys from tblname</code></li>
<li>创建索引:
<ul class="org-ul">
<li><code>ALTER TABLE table_name ADD INDEX index_name (column_list)</code></li>
<li><code>ALTER TABLE table_name ADD UNIQUE (column_list)</code></li>
<li><code>ALTER TABLE table_name ADD PRIMARY KEY (column_list)</code></li>
<li><code>CREATE INDEX index_name ON table_name (column_list)</code></li>
<li><code>CREATE UNIQUE INDEX index_name ON table_name (column_list)</code></li>
</ul></li>
<li>删除索引:
<ul class="org-ul">
<li><code>DROP INDEX index_name ON table_name</code></li>
<li><code>ALTER TABLE table_name DROP INDEX index_name</code></li>
<li><code>ALTER TABLE table_name DROP PRIMARY KEY</code></li>
</ul></li>
</ul>

<p>
查询记录:
</p>

<ul class="org-ul">
<li><code>sql = "select * from 数据表 where 字段名=字段值 order by 字段名 [desc]"</code></li>
<li><code>sql = "select * from 数据表 where 字段名 like '%字段值%' order by 字段名 [desc]"</code></li>
<li><code>sql = "select top 10 * from 数据表 where 字段名 order by 字段名 [desc]"</code></li>
<li><code>sql = "select * from 数据表 where 字段名 in ('值1','值2','值3')"</code></li>
<li><code>sql = "select * from 数据表 where 字段名 between 值1 and 值2"</code></li>
<li><code>SELECT * FROM oss_shopemployee WHERE phonenum NOT REGEXP '^[0-9]+$'</code>: 判断某一列值是否为数字</li>
<li><code>DELETE FROM oss_shopemployee WHERE phonenum NOT REGEXP '^[0-9]+$'</code>: 判断某一些是否不是数字</li>
</ul>

<p>
更新数据记录:
</p>

<ul class="org-ul">
<li><code>sql="update 数据表 set 字段名=字段值 where 条件表达式"</code></li>
<li><code>sql="update 数据表 set 字段1=值1,字段2=值2 字段n=值n where 条件表达式"</code></li>
</ul>

<p>
删除数据记录:
</p>

<ul class="org-ul">
<li><code>sql="delete from 数据表 where 条件表达式"</code></li>
<li><code>sql="delete from 数据表" (将数据表所有记录删除)</code></li>
</ul>

<p>
添加数据记录:
</p>

<ul class="org-ul">
<li><code>sql="insert into 数据表 (字段1,字段2,字段3 …) values (值1,值2,值3 …)"</code></li>
<li><code>sql="insert into 目标数据表 select * from 源数据表" (把源数据表的记录添加到目标数据表)</code></li>
</ul>

<p>
<code>DISTINCT</code> 使用:
</p>

<p>
位置: <code>DISTINCT</code> 只能放到开头，但是与其他查询函数一起使用的时候，没有位置限制: <code>select play_id, count(distinct(task_id)) from task;</code>
</p>

<p>
举例:
</p>

<ul class="org-ul">
<li>在 count 计算不重复的记录的时候能用到: <code>SELECT COUNT( DISTINCT player_id ) FROM task;</code> 就是计算表中 id 不同的记录有多少条</li>
<li>在需要返回记录不同的 id 的具体值的时候可以用: <code>SELECT DISTINCT player_id FROM task;</code> 返回表中不同的 id 的具体的值</li>
<li>上面的 情况2 对于需要返回 mysql 表中 2 列以上的结果时会有歧义: <code>SELECT DISTINCT player_id, task_id FROM task;</code>
实际上返回的是 <code>player_id</code> 与 <code>task_id</code> 同时不相同的结果,也就是 DISTINCT 同时作用了两个字段，
必须得 <code>player_id</code> 与 <code>task_id</code> 都相同的才被排除了, 与我们期望的结果不一样,我们期望的是 player_id 不同被过滤, 在这种情
况下，distinct 同时作用了两个字段，player_id, task_id。这时候可以考虑使用 <code>group_concat</code> 函数来进行排除,不过这个 mysql
函数是在 mysql4.1 以上才支持的</li>
<li>其实还有另外一种解决方式, 就是使用 <code>SELECT player_id, task_id, count(DISTINCT player_id) FROM task</code>
虽然这样的返回结果多了一列无用的count数据(有时也许就需要这个数据)</li>
<li>同时我们还可以利用下面的方式解决上面遇到的歧义问题通过 group by 分组:
<code>select player_id, task_id from task group by player_id</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgbde5db2" class="outline-3">
<h3 id="orgbde5db2"><span class="section-number-3">2.3.</span> Grant</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>查询所有用户: <code>select User from mysql.user</code></li>
<li>创建用户: <code>create user username identified by 'password'</code></li>
<li>删除用户: <code>delete from mysql.user where User="xxx"</code> -&gt; <code>flush privileges</code></li>
<li>授权: <code>grant all privileges on db_name.tablename to username</code></li>
<li>撤销权限: <code>REVOKE PRIVILEGES ON db_name.* FROM 'user_name'@'localhost';</code></li>
<li>创建用户并赋权限: <code>grant all privileges on db_name.* to news_user@'localhost' identified by 'news_password'</code>
<code>@</code> 后面是限制的主机，可以是 IP 或者 IP 段, <code>%</code> 表示任何地方。</li>
<li>查看用户权限: <code>SHOW GRANTS FOR user_name@localhost</code> 或者 <code>SELECT * FROM mysql.user WHERE user='user_name' \G</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgf41d6af" class="outline-3">
<h3 id="orgf41d6af"><span class="section-number-3">2.4.</span> Backup</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-sh">mysqldump -h$<span style="color: #000000;">{</span><span style="color: #00538b;">hostname</span><span style="color: #000000;">}</span> -u$<span style="color: #000000;">{</span><span style="color: #00538b;">username</span><span style="color: #000000;">}</span> -p$<span style="color: #000000;">{</span><span style="color: #00538b;">password</span><span style="color: #000000;">}</span>  --add-drop-table --databases $<span style="color: #000000;">{</span><span style="color: #00538b;">db_name</span><span style="color: #000000;">}</span> &gt; backupfile.sql
</pre>
</div>

<p>
同时进行压缩： <code>mysqldump -h${hostname} -u${username} -p${password} --add-drop-table --databases ${db_name} | gzip &gt; backupfile.sql.gz</code>
</p>

<p>
全量备份： <code>mysqldump –all-databases &gt; allbackupfile.sql</code>
</p>

<p>
如果只备份表结构，不备份数据，加上 <code>-d</code> 选项即可。
</p>
</div>
</div>

<div id="outline-container-org5aef409" class="outline-3">
<h3 id="org5aef409"><span class="section-number-3">2.5.</span> Restore</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre class="src src-sh">mysql -h$<span style="color: #000000;">{</span><span style="color: #00538b;">hostname</span><span style="color: #000000;">}</span> -u$<span style="color: #000000;">{</span><span style="color: #00538b;">username</span><span style="color: #000000;">}</span> -p$<span style="color: #000000;">{</span><span style="color: #00538b;">password</span><span style="color: #000000;">}</span> &lt; backupfile.sql
</pre>
</div>

<p>
解压缩，并还原： <code>gunzip backupfile.sql.gz | mysql -h${hostname} -u${username} -p${password}  ${db_name}</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org472e322" class="outline-2">
<h2 id="org472e322"><span class="section-number-2">3.</span> Data Type</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org3dc3969" class="outline-3">
<h3 id="org3dc3969"><span class="section-number-3">3.1.</span> BLOB 和 TEXT</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>BLOB 四种类型: <code>TINYBLOB</code>, <code>BLOB</code>, <code>MEDIUMBLOB</code>, <code>LONGBLOB</code></li>
<li>TEXT 四种类型: <code>TINYTEXT</code>, <code>TEXT</code>, <code>MEDIUMTEXT</code>, <code>LONGTEXT</code></li>
</ul>

<p>
区别:
</p>

<ol class="org-ol">
<li>BLOB 被视为二进制字符串, TEXT 被视为非二进制字符串</li>
<li>BLOB 列没有字符集，并且排序和比较基于列值字节的数值值。TEXT 列有一个字符集，并且根据字符集的校对规则对值进行排序和比较</li>
</ol>

<p>
<b><b>BLOB 和 TEXT 与 VARBINARY 和 VARCHAR 的不同</b></b>
</p>

<ol class="org-ol">
<li>BLOB 和 TEXT 列不能有默认值</li>
<li>当保存或检索 BLOB 和 TEXT 列的值时不删除尾部空格。(这与 VARBINARY 和 VARCHAR 列相同）</li>
<li>对于 BLOB 和 TEXT 列的索引，必须指定索引前缀的长度。对于 CHAR 和 VARCHAR，前缀长度是可选的.</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgfb81776" class="outline-2">
<h2 id="orgfb81776"><span class="section-number-2">4.</span> Configure</h2>
<div class="outline-text-2" id="text-4">
<p>
在线 my.cnf 生成器: <a href="http://imysql.com/my_cnf_generator">http://imysql.com/my_cnf_generator</a>
</p>
</div>

<div id="outline-container-orgf3ef0fe" class="outline-3">
<h3 id="orgf3ef0fe"><span class="section-number-3">4.1.</span> 某公司的 my.cnf 样例</h3>
<div class="outline-text-3" id="text-4-1">
<pre class="example" id="org49205f5">
# my.cnf
[client]
port            = 3306
socket          = /log/mysql56/mysql.sock

[mysqld]
port            = 3306
socket          = /log/mysql56/mysql.sock
pid-file        = /log/mysql56/mysqld.pid
log-error       = /log/mysql56/error.log
datadir         = /data/mysql56
tmpdir          = /data/mysql56
slow_query_log_file = /log/mysql56/slow.log
relay-log = mysqld-relay-bin
long_query_time = 1
slow_query_log = 1
sql_mode = ''
old_passwords = 0

back_log        = 1024
open_files_limit = 65535
explicit_defaults_for_timestamp = 1
default-storage-engine=InnoDB
performance_schema = 0
max_connections = 16384
table_open_cache = 8192
thread_concurrency = 32

max_connect_errors = 10000
interactive_timeout = 512
wait_timeout = 256
max_allowed_packet = 16M
binlog_cache_size = 1M
max_heap_table_size = 64M
sort_buffer_size = 2M
join_buffer_size = 2M
# 8 + (max_connections / 100)
thread_cache_size = 1024
#query_cache_size = 64M
query_cache_limit = 16M
#default_table_type = INNODB

skip-external-locking
skip-name-resolve
server-id       = 0424

#*** master ***
log-bin= bin-log
binlog_format = mixed
binlog_rows_query_log_events = 1
expire_logs_days = 3

replicate_wild_ignore_table = mysql.%
replicate_wild_ignore_table = test.%
replicate_wild_ignore_table = information_schema.%
replicate_wild_ignore_table = performance_schema.%

#*** MyISAM Specific options ***
key_buffer_size = 32M
read_buffer_size = 2M
read_rnd_buffer_size = 16M

innodb_buffer_pool_instances = 8
innodb_old_blocks_time = 1000
innodb_buffer_pool_size = 36G
innodb_log_group_home_dir = /data/mysql56
innodb_data_home_dir  = /data/mysql56
innodb_data_file_path = ibdata1:1G:autoextend
innodb_autoextend_increment = 64
innodb_read_io_threads = 16
innodb_write_io_threads = 16
innodb_thread_concurrency = 32
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
innodb_log_buffer_size = 128M
innodb_log_files_in_group = 2
innodb_log_file_size = 1G
innodb_open_files = 16384
innodb_file_per_table = 1
innodb_purge_threads = 1
innodb_stats_persistent = 0
innodb_io_capacity = 500
innodb_adaptive_flushing_lwm = 20
innodb_use_native_aio = 1
innodb_spin_wait_delay = 96
innodb_adaptive_hash_index = 0
innodb_sync_spin_loops = 100
innodb_file_format = barracuda
#innodb_doublewrite = 1
#innodb_checksum_algorithm = NONE

### slave ###
#skip_slave_start
#slave_compressed_protocol = 1
slave_parallel_workers = 4
master-info-repository = TABLE
relay-log-info-repository = TABLE
slave_type_conversions = ALL_NON_LOSSY

[mysqldump]
quick
max_allowed_packet = 16M

[mysql]
no-auto-rehash

[mysqlhotcopy]
interactive-timeout

[mysqld_safe]
open-files-limit = 65535
#pid-file         = logs/mysqld.pid
</pre>
</div>
</div>

<div id="outline-container-org6342332" class="outline-3">
<h3 id="org6342332"><span class="section-number-3">4.2.</span> 慢查询</h3>
<div class="outline-text-3" id="text-4-2">
<p>
开启:
</p>

<pre class="example" id="org92bbbd9">
slow_query_log = 1
slow_query_log_file = /data/log/mysql/mysql-slow.log
long_query_time = 0.01
log-queries-not-using-indexes
</pre>

<p>
分析工具一：mysqldumpslow（官方自带）
</p>

<ul class="org-ul">
<li><code>-s</code> 是 order 的顺序，说明写的不够详细，俺用下来，包括看了代码，主要有 c, t , l, r和 ac, at, al, ar，分别是按照 query 次数，时间，lock 的时间和返回的记录数来排序，前面加了 a 的是倒序</li>
<li><code>-t</code> 是top n的意思，即为返回前面多少条的数据</li>
<li><code>-g</code> 后边可以写一个正则匹配模式，大小写不敏感的</li>
</ul>

<p>
<code>mysqldumpslow -s c -t 20 host-slow.log</code>
</p>

<p>
分析工具二：mysqlsla（第三方）
</p>

<p>
<a href="https://github.com/daniel-nichter/hackmysql.com/tree/master/mysqlsla">https://github.com/daniel-nichter/hackmysql.com/tree/master/mysqlsla</a>
</p>
</div>
</div>

<div id="outline-container-org071f5ba" class="outline-3">
<h3 id="org071f5ba"><span class="section-number-3">4.3.</span> Docker MySQL 设置 utf8mb4 编码</h3>
<div class="outline-text-3" id="text-4-3">
<p>
<a href="https://hub.docker.com/_/mysql/">https://hub.docker.com/_/mysql/</a>
</p>

<pre class="example" id="orga46a01a">
docker run -it -d --name xxx --restart=always --network qwerty -e MYSQL_ROOT_PASSWORD=xxx  -p 3306:3306 mysql:5.7 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
</pre>

<p>
官方文档说设置 <code>--character-set-server=utf8mb4</code> 和 <code>--collation-server=utf8mb4_unicode_ci</code> 即可，但事实上是不够的，还需要修改配置：在宿主机上，添加配置文件 <code>mysql.cnf</code> ：
</p>

<div class="org-src-container">
<pre class="src src-yaml">[client]
default-character-set=utf8mb4

[mysqld]
character-set-client-handshake = FALSE
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

[mysql]
default-character-set=utf8mb4
</pre>
</div>

<p>
然后将配置 <code>docker cp</code> 到 docker 容器的 <code>/etc/mysql/conf.d</code> ，重启容器（启动时会自动加载 <code>conf.d</code> 下的 <code>*.cnf</code> ）。 这样才能正常的支持 <code>utf8mb4</code> 编码。
</p>

<p>
还有一种办法是基于官方镜像，重新制作镜像，在 Dockerfile 中将配置 <code>CP</code> 到镜像中。
</p>

<p>
但是导入的数据库，emoji 表情显示为 <code>?</code> ，字符也都没有问题，具体原因还没找到。
</p>
</div>
</div>
</div>

<div id="outline-container-orga5acffc" class="outline-2">
<h2 id="orga5acffc"><span class="section-number-2">5.</span> Best Practices</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>在控制台执行一条 SQL 语句: <code>mysql -h127.0.0.1 -uuser -ppassword db_name -e "select xxx from xxx" &gt; aa.txt</code></li>
<li>控制台中文乱码: <code>set names 'utf8'</code></li>
<li>MySQL 报错: Row size too large (&gt; 8126). Changing some columns to TEXT or BLOB or using ROW_FORMAT=DYNAMIC &#x2026; 解决方案: <a href="http://hidba.org/?p=551">innodb使用大字段text，blob的一些优化建议</a>。</li>
<li><a href="http://stackoverflow.com/questions/286039/get-record-counts-for-all-tables-in-mysql-database">Get record counts for all tables in MySQL database</a></li>
<li>系统配置文件位置: <code>mysql --help | grep cnf</code></li>
<li><p>
MySQL 5.6 占内存解决方法:
</p>
<pre class="example" id="org69931ea">
performance_schema_max_table_instances=400
table_definition_cache=400
table_open_cache=256
</pre></li>
<li>数据库总行数: <code>SELECT SUM(TABLE_ROWS) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'db_name'</code>;</li>
<li>数据库每一个表的长度: <code>SELECT table_name, table_rows FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'test1' order by table_rows desc;</code>;</li>
<li><p>
数据库中每一个表的大小:
</p>
<pre class="example" id="org29efdc8">
SELECT
  TABLE_NAME AS `Table`,
  ROUND((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024) AS `Size (MB)`
FROM
    information_schema.TABLES
WHERE
    TABLE_SCHEMA = "bookstore"
ORDER BY
    (DATA_LENGTH + INDEX_LENGTH)
DESC;
</pre></li>
<li><p>
数据库中某一个表的大小(扩展: <a href="https://chartio.com/resources/tutorials/how-to-get-the-size-of-a-table-in-mysql">https://chartio.com/resources/tutorials/how-to-get-the-size-of-a-table-in-mysql</a>):
</p>
<pre class="example" id="org20f7863">
SELECT
TABLE_NAME AS `Table`,
ROUND((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024) AS `Size (MB)`
FROM
information_schema.TABLES
WHERE
TABLE_SCHEMA = "bookstore"
AND
TABLE_NAME = "book"
ORDER BY
(DATA_LENGTH + INDEX_LENGTH)
DESC;
</pre></li>
<li>数据库占空间大小: <code>SELECT sum(DATA_LENGTH)+sum(INDEX_LENGTH) FROM information_schema.TABLES where TABLE_SCHEMA='db_name';</code> 返回大小单位为字节;</li>
<li>查询数据存储位置: <code>show variables like "%dir%";</code>;</li>
<li>修改 root 密码:
<ul class="org-ul">
<li>在已知密码的情况下: <code>SET PASSWORD FOR 'root'@'localhost' = PASSWORD('MyNewPass');</code></li>
<li><a href="http://stackoverflow.com/questions/5683154/how-do-i-find-out-my-root-mysql-password">Howdo I find out my root MySQL password?</a></li>
</ul></li>
<li>auto_increment 存在的问题: <a href="http://www.kancloud.cn/taobaomysql/monthly/67122">http://www.kancloud.cn/taobaomysql/monthly/67122</a></li>
<li>设置输出分隔符: <code>mysql -umyuser -pmydb dbname -e "select CONCAT_WS(',' , f1 , f2) from mytable;" &gt; /tmp/mydata.txt</code></li>
<li>设置默认编码为 <code>ut8mb4</code> <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup></li>
<li>macOS 下 stop MySQL，使用 <code>mysql.server stop</code> 或者 <code>kill</code> 命令删掉之后会自动重启，正确的方法是找到 MySQL 的 plist，然后 unload 掉，
比如: <code>launchctl unload /usr/local/Cellar/mysql@5.6/5.6.36_1/homebrew.mxcl.mysql\@5.6.plist</code> ，具体见这个 <sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup></li>
<li>查看字符集的三种方法
<ul class="org-ul">
<li>查看 MySQL 服务器的字符集: <code>show variables like '%char%';</code></li>
<li>查看某个库中表的字符集: <code>show table status from db like '%xxx%';</code></li>
<li>查看表中每一列的字符集: <code>show full columns from xxx_table;</code></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org2e1da70" class="outline-2">
<h2 id="org2e1da70"><span class="section-number-2">6.</span> Resource</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li><a href="https://www.pureweber.com/article/myisam-vs-innodb/">MyISAM vs InnoDB</a></li>
<li><a href="http://www.cnblogs.com/8765h/archive/2011/11/25/2374167.html">SQL truncate 、delete与drop区别</a></li>
<li><a href="http://blog.chinaunix.net/uid-20639775-id-3249105.html">MYSQL数据库管理之权限管理</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_1380b3f180102vsg5.html">根据多年经验整理的《互联网MySQL开发规范》</a></li>
<li><a href="http://blog.opskumu.com/mysql-rep.html">MySQL 复制备忘</a></li>
</ul>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://www.zhangjiee.com/blog/2017/mysql-utf8-to-utf8mb4.html">https://www.zhangjiee.com/blog/2017/mysql-utf8-to-utf8mb4.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://superuser.com/questions/159486/how-to-kill-process-in-mac-os-x-and-not-have-it-restart-on-its-own">https://superuser.com/questions/159486/how-to-kill-process-in-mac-os-x-and-not-have-it-restart-on-its-own</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="postamble">First created: 2017-12-04 10:54:25 <br />Last updated: 2022-08-23 Tue 18:22 <br />Power by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.5.4)</p>
</div>
</body>
</html>
